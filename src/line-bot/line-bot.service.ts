import { Inject, Injectable } from '@nestjs/common';
import * as line from '@line/bot-sdk';
import { FlexBubble, FlexMessage, PushMessageRequest, ReplyMessageRequest } from '@line/bot-sdk/dist/messaging-api/api';
import { WebhookEvent } from '@line/bot-sdk';
import { TwStockInfoService } from 'src/tw-stock-info/tw-stock-info.service';

@Injectable()
export class LineBotService {

  constructor(
    @Inject('LINE_CLIENT')
    private readonly lineClient: line.messagingApi.MessagingApiClient,
    private readonly twStockInfoService: TwStockInfoService
  ) { }

  async handleEvent(event: WebhookEvent): Promise<any> {
    if (event.type !== 'message' || event.message.type !== 'text') {
      return null;
    }
    /* 
    * TODO: 
    * 1. Ëß£Êûê‰ΩøÁî®ËÄÖÂÇ≥ÂÖ•ËÇ°Á•®‰ª£Ëôü
    * 2. ÂõûÂÇ≥Ë®äÊÅØÊéíÁâà
    */
    switch (event.message.text) {
      case 'bye':
        return this.replyText(event.replyToken, 'Goodbye!');
      case 'user':
        return this.replyText(event.replyToken, event.source.userId);
      case 'd':
        return this.getDailyMarketInfoAsync(event.source.userId, 10);
      case 'a':
        return this.getAfterTradingVolumeAsync(event.source.userId, '6558');
      case 't':
        return this.getTopVolumeItemsAsync(event.source.userId);
      case 'n':
        return this.getStockNewsAsync(event.source.userId,'2330');
      default:
        return this.replyText(event.replyToken, 'Sorry, I did not understand that.');
    }
  }

  // ÂÇ≥ÈÄÅÁï∂ÊúàÂ∏ÇÂ†¥Êàê‰∫§Ë≥áË®ä
  private async getDailyMarketInfoAsync(userId: string, count?: number) {
    var info = await this.twStockInfoService.getDailyMarketInfoAsync(count);
    var result = await this.formatDailyMarketInfoToFlexMessage(info);
    this.pushMessage(userId, result);
  }

  // ÂÇ≥ÈÄÅÂÄãËÇ°Áï∂Êó•Êàê‰∫§Ë≥áË®ä
  private async getAfterTradingVolumeAsync(userId: string, symbol: string) {
    var info = await this.twStockInfoService.getAfterTradingVolumeAsync(symbol);
    var result = await this.formatStockInfoToFlexMessage(info);
    this.pushMessage(userId, result);
  }

  // ÂÇ≥ÈÄÅÊàê‰∫§ÈáèÂâç20ËÇ°Á•®
  private async getTopVolumeItemsAsync(userId: string) {
    var info = await this.twStockInfoService.getTopVolumeItemsAsync();
    var result = await this.formatTopTenToFlexMessage(info);
    this.pushMessage(userId, result);
  }

  // ÂÇ≥ÈÄÅËÇ°Á•®Êñ∞ËÅû
  private async getStockNewsAsync(userId: string, symbol: string) {
    var info = await this.twStockInfoService.getStockNewsAsync(symbol);
    var result = await this.formatNewsToFlexMessage(info);
    this.pushMessage(userId, result);
  }

  // Êé®ÈÄÅFlexMessageË®äÊÅØ
  private pushMessage(userId: string, flexMessage: FlexMessage): Promise<any> {
    const message: PushMessageRequest = {
      to: userId,
      messages: [flexMessage]
    };

    return this.lineClient.pushMessage(message);
  }

  // ÂõûË¶ÜË®äÊÅØ
  private replyText(replyToken: string, text: string): Promise<any> {
    const message: ReplyMessageRequest = {
      replyToken,
      messages: [{ type: 'text', text }]
    };

    return this.lineClient.replyMessage(message);
  }

  private formatDailyMarketInfoToFlexMessage(data: object[][]): FlexMessage {
    const bubbles: FlexBubble[] = data.map(item => {
      const changeValue = parseFloat(item[5].toString());
      const changeColor = changeValue >= 0 ? '#E63946' : '#2A9D8F'; // Êº≤Áî®Á¥ÖËâ≤ÔºåË∑åÁî®Á∂†Ëâ≤

      return {
        type: 'bubble',
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: 'Âè∞ËÇ°Êó•‰∫§ÊòìË≥áË®ä',
              weight: 'bold',
              size: 'xl',
              color: '#333333',
              margin: 'md'
            },
            {
              type: 'text',
              text: item[0].toString(),
              size: 'sm',
              color: '#666666',
              margin: 'sm'
            },
            {
              type: 'separator',
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              margin: 'lg',
              spacing: 'sm',
              contents: [
                {
                  type: 'box',
                  layout: 'horizontal',
                  contents: [
                    {
                      type: 'text',
                      text: 'ÁôºË°åÈáèÂä†Ê¨äÊåáÊï∏',
                      size: 'md',
                      color: '#333333',
                      flex: 6
                    },
                    {
                      type: 'text',
                      text: item[4].toString(),
                      size: 'md',
                      color: '#000000',
                      align: 'end',
                      flex: 4
                    }
                  ]
                },
                {
                  type: 'box',
                  layout: 'horizontal',
                  contents: [
                    {
                      type: 'text',
                      text: 'Êº≤Ë∑åÈªûÊï∏',
                      size: 'md',
                      color: changeColor,
                      flex: 6
                    },
                    {
                      type: 'text',
                      text: item[5].toString(),
                      size: 'md',
                      color: changeColor,
                      align: 'end',
                      flex: 4,
                      weight: 'bold'
                    }
                  ]
                },
                {
                  type: 'separator',
                  margin: 'lg'
                },
                {
                  type: 'box',
                  layout: 'vertical',
                  margin: 'lg',
                  contents: [
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        {
                          type: 'text',
                          text: 'Êàê‰∫§ËÇ°Êï∏',
                          size: 'sm',
                          color: '#666666',
                          flex: 6
                        },
                        {
                          type: 'text',
                          text: item[1].toString(),
                          size: 'sm',
                          color: '#333333',
                          align: 'end',
                          flex: 4
                        }
                      ],
                      margin: 'sm'
                    },
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        {
                          type: 'text',
                          text: 'Êàê‰∫§ÈáëÈ°ç',
                          size: 'sm',
                          color: '#666666',
                          flex: 6
                        },
                        {
                          type: 'text',
                          text: item[2].toString(),
                          size: 'sm',
                          color: '#333333',
                          align: 'end',
                          flex: 4
                        }
                      ],
                      margin: 'sm'
                    },
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        {
                          type: 'text',
                          text: 'Êàê‰∫§Á≠ÜÊï∏',
                          size: 'sm',
                          color: '#666666',
                          flex: 6
                        },
                        {
                          type: 'text',
                          text: item[3].toString(),
                          size: 'sm',
                          color: '#333333',
                          align: 'end',
                          flex: 4
                        }
                      ],
                      margin: 'sm'
                    }
                  ]
                }
              ]
            }
          ],
          backgroundColor: '#F5F5F5'
        }
      };
    });

    return {
      type: 'flex',
      altText: 'Âè∞ËÇ°‰ªäÊó•Â§ßÁõ§‰∫§ÊòìË≥áË®ä',
      contents: {
        type: 'carousel',
        contents: bubbles
      }
    };
  }

  private formatStockInfoToFlexMessage(stockInfo: any[]): FlexMessage {
    // ‰øÆÊ≠£Êº≤Ë∑åÁ¨¶ËôüËôïÁêÜ
    const upDownSign = stockInfo[9]?.toString()?.trim().replace(/<[^>]*>/g, '') || '';
    const getUpDownSign = (sign: string) => {
      if (sign.includes('+')) return '+';
      if (sign.includes('-')) return '-';
      return '';
    };
    const actualUpDownSign = getUpDownSign(upDownSign);

    const changeAmount = parseFloat(stockInfo[10]?.toString() || '0') || 0;
    const openPrice = parseFloat(stockInfo[5]?.toString() || '0') || 0;
    const changeColor = upDownSign === "+" ? "#E63946" : upDownSign === "-" ? "#2A9D8F" : "#333333";
    const percentageChange = openPrice !== 0 ? `${(changeAmount / openPrice * 100).toFixed(2)}%` : "0.00%";

    return {
      type: "flex",
      altText: `${stockInfo[1]} (${stockInfo[0]}) ËÇ°Á•®Ë≥áË®ä`,
      contents: {
        type: "bubble",
        body: {
          type: "box",
          layout: "vertical",
          contents: [
            {
              type: "box",
              layout: "horizontal",
              contents: [
                {
                  type: "text",
                  text: `${stockInfo[1]} (${stockInfo[0]})`,
                  weight: "bold",
                  size: "xl",
                  color: "#333333",
                  flex: 5
                },
                {
                  type: "text",
                  text: upDownSign === "+" ? "üìà" : upDownSign === "-" ? "üìâ" : "‚ûñ",
                  size: "xl",
                  flex: 1,
                  align: "end"
                }
              ]
            },
            {
              type: "separator",
              margin: "lg"
            },
            {
              type: "box",
              layout: "vertical",
              spacing: "sm",
              margin: "lg",
              contents: [
                {
                  type: "box",
                  layout: "horizontal",
                  contents: [
                    {
                      type: "text",
                      text: "Êî∂Áõ§ÂÉπ",
                      size: "md",
                      color: "#666666",
                      flex: 3
                    },
                    {
                      type: "text",
                      text: stockInfo[8],
                      size: "xl",
                      color: changeColor,
                      align: "end",
                      weight: "bold",
                      flex: 4
                    }
                  ]
                },
                {
                  type: "box",
                  layout: "horizontal",
                  contents: [
                    {
                      type: "text",
                      text: "Êº≤Ë∑å",
                      size: "sm",
                      color: "#666666",
                      flex: 3
                    },
                    {
                      type: "text",
                      text: `${actualUpDownSign}${changeAmount} (${percentageChange})`,
                      size: "sm",
                      color: changeColor,
                      align: "end",
                      flex: 4
                    }
                  ]
                }
              ]
            },
            {
              type: "box",
              layout: "vertical",
              margin: "lg",
              contents: [
                ["Êàê‰∫§ËÇ°Êï∏", stockInfo[2]],
                ["Êàê‰∫§ÈáëÈ°ç", stockInfo[4]],
                ["Êàê‰∫§Á≠ÜÊï∏", stockInfo[3]],
                ["ÈñãÁõ§ÂÉπ", stockInfo[5]],
                ["ÊúÄÈ´òÂÉπ", stockInfo[6]],
                ["ÊúÄ‰ΩéÂÉπ", stockInfo[7]]
              ].map(([label, value]) => ({
                type: "box",
                layout: "horizontal",
                margin: "sm",
                contents: [
                  {
                    type: "text",
                    text: label,
                    size: "sm",
                    color: "#666666",
                    flex: 3
                  },
                  {
                    type: "text",
                    text: value?.toString() || "",
                    size: "sm",
                    color: "#333333",
                    align: "end",
                    flex: 4
                  }
                ]
              }))
            }
          ]
        }
      }
    };
  }

  private formatTopTenToFlexMessage(stockData: any[][]): FlexMessage {
    const topTen = stockData.slice(0, 10);

    return {
      type: 'flex',
      altText: '‰ªäÊó•‰∫§ÊòìÈáèÂâçÂçÅÂêç',
      contents: {
        type: 'bubble',
        size: 'giga',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [{
            type: 'text',
            text: '‰ªäÊó•‰∫§ÊòìÈáèÊéíË°å',
            weight: 'bold',
            size: 'xl',
            align: 'center'
          }],
          backgroundColor: '#F5F5F5'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          spacing: 'md',
          contents: topTen.map((item, index) => {
            const upDownSign = item[9]?.toString()?.trim().replace(/<[^>]*>/g, '') || '';
            const changeAmount = parseFloat(item[10]?.toString() || '0') || 0;
            const openPrice = parseFloat(item[5]?.toString() || '0') || 0;
            const changeColor = upDownSign.includes('+') ? '#E63946' :
              upDownSign.includes('-') ? '#2A9D8F' : '#333333';
            const percentageChange = openPrice !== 0 ?
              `${(changeAmount / openPrice * 100).toFixed(2)}%` : "0.00%";

            return {
              type: 'box',
              layout: 'vertical',
              backgroundColor: index % 2 === 0 ? '#FFFFFF' : '#F8F8F8',
              paddingAll: '10px',
              contents: [
                // Ê®ôÈ°åÂàó
                {
                  type: 'box',
                  layout: 'horizontal',
                  contents: [
                    {
                      type: 'text',
                      text: `${index + 1}. ${item[2].replace(/\s+/g, '')}(${item[1].replace(/\s+/g, '')}) ${upDownSign.includes('+') ? "üìà" : upDownSign.includes('-') ? "üìâ" : "‚ûñ"}`, // ÁµÑÂêàÊñáÂ≠óÔºåÁßªÈô§Á©∫Ê†º
                      size: 'sm',
                      color: changeColor,
                      weight: 'bold',
                      flex: 9, // ÂàÜÈÖçÂ§ßÈÉ®ÂàÜÂØ¨Â∫¶Áµ¶ÊñáÂ≠ó
                      margin: 'none'
                    }
                  ],
                  spacing: 'none', // ÁßªÈô§ÂÖßÈÉ®ÁöÑÈñìË∑ù
                  paddingAll: '5px', // Ê∏õÂ∞ëÊï¥È´îÂÖßÈÇäË∑ù
                },
                // ‰∫§ÊòìË≥áË®ä
                {
                  type: 'box',
                  layout: 'vertical',
                  margin: 'sm',
                  contents: [
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        { type: 'text', text: 'Êàê‰∫§ËÇ°Êï∏', size: 'xs', color: '#666666', flex: 3 },
                        { type: 'text', text: item[3]?.toString() || '0', size: 'xs', color: '#333333', align: 'end', flex: 7 }
                      ]
                    },
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        { type: 'text', text: 'Êàê‰∫§Á≠ÜÊï∏', size: 'xs', color: '#666666', flex: 3 },
                        { type: 'text', text: item[4]?.toString() || '0', size: 'xs', color: '#333333', align: 'end', flex: 7 }
                      ]
                    },
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        { type: 'text', text: 'ÈñãÁõ§ÂÉπ', size: 'xs', color: '#666666', flex: 3 },
                        { type: 'text', text: item[5]?.toString() || '0', size: 'xs', color: '#333333', align: 'end', flex: 7 }
                      ]
                    },
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        { type: 'text', text: 'Êî∂Áõ§ÂÉπ', size: 'xs', color: '#666666', flex: 3 },
                        { type: 'text', text: item[8]?.toString() || '0', size: 'xs', color: changeColor, align: 'end', flex: 7, weight: 'bold' }
                      ]
                    },
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        { type: 'text', text: 'Êº≤Ë∑åÂπÖ', size: 'xs', color: '#666666', flex: 3 },
                        { type: 'text', text: `${upDownSign}${changeAmount} (${percentageChange})`, size: 'xs', color: changeColor, align: 'end', flex: 7 }
                      ]
                    },
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        { type: 'text', text: 'ÊúÄÈ´òÂÉπ', size: 'xs', color: '#666666', flex: 3 },
                        { type: 'text', text: item[6]?.toString() || '0', size: 'xs', color: '#333333', align: 'end', flex: 7 }
                      ]
                    },
                    {
                      type: 'box',
                      layout: 'horizontal',
                      contents: [
                        { type: 'text', text: 'ÊúÄ‰ΩéÂÉπ', size: 'xs', color: '#666666', flex: 3 },
                        { type: 'text', text: item[7]?.toString() || '0', size: 'xs', color: '#333333', align: 'end', flex: 7 }
                      ]
                    }
                  ]
                }
              ]
            };
          })
        }
      }
    };
  }

  private formatNewsToFlexMessage(newsData: YahooNewsRssResponse[]): FlexMessage {
    return {
      type: 'flex',
      altText: 'ÊúÄÊñ∞ËÇ°Â∏ÇÊñ∞ËÅû',
      contents: {
        type: 'bubble',
        size: 'giga',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [{
            type: 'text',
            text: 'ÊúÄÊñ∞ËÇ°Â∏ÇÊñ∞ËÅû',
            weight: 'bold',
            size: 'xl',
            align: 'center'
          }],
          backgroundColor: '#F5F5F5'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          spacing: 'md',
          contents: newsData.map((item, index) => ({
            type: 'box',
            layout: 'vertical',
            backgroundColor: index % 2 === 0 ? '#FFFFFF' : '#F8F8F8',
            paddingAll: '10px',
            contents: [
              {
                type: 'text',
                text: `${item.title}`,
                wrap: true,
                size: 'sm',
                color: '#1a73e8',
                action: {
                  type: 'uri',
                  label: 'View Details',
                  uri: item.link || ''
                }
              }
            ]
          }))
        }
      }
    };
  }
}
